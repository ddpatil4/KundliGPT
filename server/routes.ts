import type { Express } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage";
import { insertContactMessageSchema, kundliFormSchema } from "@shared/schema";
import OpenAI from "openai";

// In-memory rate limiter
const rateLimiter = new Map<string, { count: number; resetTime: number }>();

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const windowMs = 10 * 60 * 1000; // 10 minutes
  const maxRequests = 10;

  const userLimit = rateLimiter.get(ip);
  if (!userLimit || now > userLimit.resetTime) {
    rateLimiter.set(ip, { count: 1, resetTime: now + windowMs });
    return true;
  }

  if (userLimit.count >= maxRequests) {
    return false;
  }

  userLimit.count++;
  return true;
}

export async function registerRoutes(app: Express): Promise<Server> {
  const openai = new OpenAI({ 
    apiKey: process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY_ENV_VAR || "default_key"
  });

  // Kundli interpretation API
  app.post("/api/interpret", async (req, res) => {
    try {
      const clientIp = req.ip || req.connection.remoteAddress || "unknown";
      
      if (!checkRateLimit(clientIp)) {
        return res.status(429).json({ 
          ok: false, 
          error: "рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЕрдиреБрд░реЛрдзред рдХреГрдкрдпрд╛ 10 рдорд┐рдирдЯ рдмрд╛рдж рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" 
        });
      }

      const formData = kundliFormSchema.parse(req.body);
      
      if (!process.env.OPENAI_API_KEY) {
        return res.status(500).json({
          ok: false,
          error: "рд╕реЗрд╡рд╛ рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЕрдиреБрдкрд▓рдмреНрдз рд╣реИред рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред"
        });
      }

      const systemPrompt = "рдЖрдк рдПрдХ рдЕрдиреБрднрд╡реА рд╣рд┐рдВрджреА рдЬреНрдпреЛрддрд┐рд╖реА рд╣реИрдВред рдирд┐рдореНрди рд╕рднреА 8 рдкреНрд░рд╢реНрдиреЛрдВ рдХреЗ рд╡рд┐рд╕реНрддреГрдд рдЙрддреНрддрд░ рджреЗрдВред рд╣рд░ рдкреНрд░рд╢реНрди рдХрд╛ complete answer рджреЗрдирд╛ рдЬрд░реВрд░реА рд╣реИред рдХреЛрдИ рдкреНрд░рд╢реНрди рдЫреЛрдбрд╝реЗрдВ рдирд╣реАрдВред";

      const userPrompt = `${formData.name} рдХреА рдХреБрдВрдбрд▓реА рдХреЗ рд╕рднреА 8 рдкреНрд░рд╢реНрдиреЛрдВ рдХреЗ complete answers рджреЗрдВ:

рдЬрдиреНрдо рд╡рд┐рд╡рд░рдг: ${formData.name}, ${formData.birthDate}, ${formData.birthTime}, ${formData.birthPlace || 'рджрд┐рдпрд╛ рдЧрдпрд╛ рд╕реНрдерд╛рди'}

IMPORTANT: рд╕рднреА 8 рдкреНрд░рд╢реНрдиреЛрдВ рдХреЗ detailed answers рджреЗрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдХреЛрдИ рднреА рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ missing рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

<h2>ЁЯМЯ рдкреНрд░рд╢реНрди 1: рдореЗрд░рд╛ рд╡реНрдпрдХреНрддрд┐рддреНрд╡ рдХреИрд╕рд╛ рд╣реИ?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЖрдкрдХрд╛ рд╕реНрд╡рднрд╛рд╡ рдорд┐рд▓рдирд╕рд╛рд░ рдФрд░ рд╕рдХрд╛рд░рд╛рддреНрдордХ рд╣реИред рдЖрдк рд╕реНрд╡рддрдВрддреНрд░ рд╡рд┐рдЪрд╛рд░рдзрд╛рд░рд╛ рдХреЗ рд╡реНрдпрдХреНрддрд┐ рд╣реИрдВ рдФрд░ рдирдИ рдЪреБрдиреМрддрд┐рдпреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдиреЗ рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВред рдЖрдкрдореЗрдВ рдиреЗрддреГрддреНрд╡ рдХреЗ рдЧреБрдг рд╣реИрдВ рдФрд░ рдЖрдк рджреВрд╕рд░реЛрдВ рдХреА рдорджрдж рдХрд░рдирд╛ рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВред</p>
<br>

<h2>ЁЯПЖ рдкреНрд░рд╢реНрди 2: рдореЗрд░реЗ рд▓рд┐рдП рдХреМрди рд╕рд╛ рдХрд░рд┐рдпрд░ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЖрдкрдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╖реЗрддреНрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдпреБрдХреНрдд рд╣реИрдВ:</p>
<ul>
<li>рд╢рд┐рдХреНрд╖рд╛ рдФрд░ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреНрд╖реЗрддреНрд░ - рдЖрдкрдХреА рд╕рдВрд╡рд╛рдж рдХреНрд╖рдорддрд╛ рдЙрддреНрдХреГрд╖реНрдЯ рд╣реИ</li>
<li>рд╡реНрдпрд╡рд╕рд╛рдп рдФрд░ рдкреНрд░рдмрдВрдзрди - рдиреЗрддреГрддреНрд╡ рдЧреБрдгреЛрдВ рдХреЗ рдХрд╛рд░рдг</li>
<li>рддрдХрдиреАрдХреА рдХреНрд╖реЗрддреНрд░ - рдирд╡рд╛рдЪрд╛рд░ рдХреА рд╕реЛрдЪ рд╣реИ</li>
</ul>
<br>

<h2>ЁЯТН рдкреНрд░рд╢реНрди 3: рдореЗрд░реА рд╢рд╛рджреА рдХрдм рд╣реЛрдЧреА?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЬреНрдпреЛрддрд┐рд╖реАрдп рд╕рдВрдХреЗрддреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╡рд┐рд╡рд╛рд╣ рдХреЗ рд▓рд┐рдП 2025-2027 рдХрд╛ рд╕рдордп рдЕрдиреБрдХреВрд▓ рджрд┐рдЦ рд░рд╣рд╛ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ, рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдЖрдкрдХреЗ рдкреНрд░рдпрд╛рд╕реЛрдВ рдФрд░ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред</p>
<br>

<h2>ЁЯМЩ рдкреНрд░рд╢реНрди 4: рдЕрднреА рдХреМрди рд╕рд╛ рдЧреНрд░рд╣ рдореБрдЭ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓ рд░рд╣рд╛ рд╣реИ?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдмреБрдз рдФрд░ рд╢реБрдХреНрд░ рдЧреНрд░рд╣ рдХрд╛ рдкреНрд░рднрд╛рд╡ рдкреНрд░рдореБрдЦ рд╣реИ рдЬреЛ рдЖрдкрдХреА рдмреБрджреНрдзрд┐, рд╕рдВрд╡рд╛рдж рдХреМрд╢рд▓ рдФрд░ рд░рд┐рд╢реНрддреЛрдВ рдореЗрдВ рд╕рдХрд╛рд░рд╛рддреНрдордХрддрд╛ рд▓рд╛ рд░рд╣рд╛ рд╣реИред рдпрд╣ рд╕рдордп рдирдИ рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП рдЕрдЪреНрдЫрд╛ рд╣реИред</p>
<br>

<h2>тЪб рдкреНрд░рд╢реНрди 5: рдХреНрдпрд╛ рдореИрдВ рд╕рд╛рдврд╝реЗрд╕рд╛рддреА рдпрд╛ рдЕрд╖реНрдЯрдо рд╢рдирд┐ рдХреЗ рджреМрд░ рдореЗрдВ рд╣реВрдВ?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЖрдк рд╡рд░реНрддрдорд╛рди рдореЗрдВ рд╢рдирд┐ рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рднрд╛рд╡ рдореЗрдВ рд╣реИрдВ, рд╕рд╛рдврд╝реЗрд╕рд╛рддреА рдХреА рд╕реНрдерд┐рддрд┐ рдирд╣реАрдВ рд╣реИред рдпрд╣ рд╕рдордп рд╕реНрдерд┐рд░рддрд╛ рдФрд░ рдзреИрд░реНрдп рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рд╣реИред рдХреЛрдИ рдмрдбрд╝реА рдЪреБрдиреМрддреА рдирд╣реАрдВ рджрд┐рдЦ рд░рд╣реАред</p>
<br>

<h2>ЁЯОп рдкреНрд░рд╢реНрди 6: рдореЗрд░реА рд╕рдмрд╕реЗ рдмрдбрд╝реА рд╢рдХреНрддрд┐ рдФрд░ рдХрдордЬреЛрд░реА рдХреНрдпрд╛ рд╣реИ?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЖрдкрдХреА рдкреНрд░рдореБрдЦ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИрдВ:</p>
<p><strong>рд╢рдХреНрддрд┐рдпрд╛рдВ:</strong> рджреГрдврд╝ рд╕рдВрдХрд▓реНрдк, рдЕрдЪреНрдЫреА рд╕рдВрд╡рд╛рдж рдХреНрд╖рдорддрд╛, рдиреЗрддреГрддреНрд╡ рдЧреБрдг, рдФрд░ рджреВрд╕рд░реЛрдВ рдХреА рд╕рд╣рд╛рдпрддрд╛ рдХрд░рдиреЗ рдХреА рдкреНрд░рд╡реГрддреНрддрд┐</p>
<p><strong>рд╕реБрдзрд╛рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛:</strong> рдХрднреА-рдХрднреА рдЬрд▓реНрджрдмрд╛рдЬреА рдореЗрдВ рдирд┐рд░реНрдгрдп рд▓реЗрдирд╛ рдФрд░ рдЕрдзрд┐рдХ рдзреИрд░реНрдп рд░рдЦрдиреЗ рдХреА рдЬрд░реВрд░рдд</p>
<br>

<h2>ЁЯТ░ рдкреНрд░рд╢реНрди 7: рдкреИрд╕реЗ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдХреИрд╕рд╛ рд░рд╣реЗрдЧрд╛?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдЖрд░реНрдерд┐рдХ рд╕реНрдерд┐рддрд┐ рдзреАрд░реЗ-рдзреАрд░реЗ рд╕реБрдзрд╛рд░ рдХреА рдУрд░ рд╣реИред рдирд┐рдпрдорд┐рдд рдЖрдп рдХреЗ рд╕реНрд░реЛрдд рд╕реНрдерд┐рд░ рд░рд╣реЗрдВрдЧреЗред рдирд┐рд╡реЗрд╢ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рд╛рд╡рдзрд╛рдиреА рдмрд░рддреЗрдВ рдФрд░ рдмрдЪрдд рдХреА рдЖрджрдд рдбрд╛рд▓реЗрдВред</p>
<br>

<h2>ЁЯЩП рдкреНрд░рд╢реНрди 8: рдореБрдЭреЗ рдХреМрди рд╕реЗ рдЙрдкрд╛рдп рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП?</h2>
<p><strong>рдЙрддреНрддрд░:</strong> рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрд╛рдп рдЖрдкрдХреЗ рд▓рд┐рдП рд▓рд╛рднрдХрд╛рд░реА рд╣реИрдВ:</p>
<ul>
<li>рдкреНрд░рддрд┐рджрд┐рди рд╕реБрдмрд╣ рд╕реВрд░реНрдп рдХреЛ рдЬрд▓ рдЕрд░реНрдкрд┐рдд рдХрд░реЗрдВ</li>
<li>рд╢рд┐рдХреНрд╖рд╛ рдФрд░ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЗ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рджрд╛рди рдХрд░реЗрдВ</li>
<li>рдпреЛрдЧ рдФрд░ рдзреНрдпрд╛рди рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ</li>
<li>рд╕рдХрд╛рд░рд╛рддреНрдордХ рд╕реЛрдЪ рд░рдЦреЗрдВ рдФрд░ рдХрдард┐рди рдкрд░рд┐рд╢реНрд░рдо рдХрд░реЗрдВ</li>
</ul>
<br>

<h2>тЪая╕П рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрд╕реНрд╡реАрдХрд░рдг</h2>
<p>рдпрд╣ рдХреЗрд╡рд▓ рдЬреНрдпреЛрддрд┐рд╖реАрдп рдорд╛рд░реНрдЧрджрд░реНрд╢рди рд╣реИ, 100% рд╕рдЯреАрдХрддрд╛ рдХреА рдЧрд╛рд░рдВрдЯреА рдирд╣реАрдВред рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд┐рд░реНрдгрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдпреЛрдЧреНрдп рд╕рд▓рд╛рд╣рдХрд╛рд░ рд╕реЗ рдорд┐рд▓реЗрдВред</p>`;

      // Try gpt-4o first as fallback since gpt-5 might have issues
      console.log("Making OpenAI request with prompt length:", userPrompt.length);
      
      const response = await openai.chat.completions.create({
        model: "gpt-4o",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        max_tokens: 4000,
        temperature: 0.7,
      });

      const resultHtml = response.choices[0].message.content;

      // Check if we got a valid response
      if (!resultHtml || resultHtml.trim() === '') {
        console.error("Empty response from OpenAI");
        return res.status(500).json({ 
          ok: false, 
          error: "AI рд╕реЗрд╡рд╛ рд╕реЗ рдЦрд╛рд▓реА рдЙрддреНрддрд░ рдорд┐рд▓рд╛ред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" 
        });
      }

      console.log("OpenAI response length:", resultHtml.length);
      res.json({ ok: true, resultHtml });
    } catch (error) {
      console.error("Error in /api/interpret:", error);
      res.status(500).json({ 
        ok: false, 
        error: "рдХреБрдЫ рддрдХрдиреАрдХреА рд╕рдорд╕реНрдпрд╛ рд╣реБрдИ рд╣реИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" 
      });
    }
  });

  // Contact form API
  app.post("/api/contact", async (req, res) => {
    try {
      const contactData = insertContactMessageSchema.parse(req.body);
      
      const message = await storage.createContactMessage(contactData);
      console.log("New contact message:", message);
      
      res.json({ ok: true, message: "рдЖрдкрдХрд╛ рд╕рдВрджреЗрд╢ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╣реИред" });
    } catch (error) {
      console.error("Error in /api/contact:", error);
      res.status(500).json({ 
        ok: false, 
        error: "рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реБрдИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" 
      });
    }
  });

  // Sitemap
  app.get("/sitemap.xml", (req, res) => {
    const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://${req.get('host')}/</loc>
    <lastmod>${new Date().toISOString()}</lastmod>
    <priority>1.0</priority>
  </url>
  <url>
    <loc>https://${req.get('host')}/about</loc>
    <lastmod>${new Date().toISOString()}</lastmod>
    <priority>0.8</priority>
  </url>
  <url>
    <loc>https://${req.get('host')}/contact</loc>
    <lastmod>${new Date().toISOString()}</lastmod>
    <priority>0.7</priority>
  </url>
  <url>
    <loc>https://${req.get('host')}/privacy</loc>
    <lastmod>${new Date().toISOString()}</lastmod>
    <priority>0.5</priority>
  </url>
  <url>
    <loc>https://${req.get('host')}/terms</loc>
    <lastmod>${new Date().toISOString()}</lastmod>
    <priority>0.5</priority>
  </url>
</urlset>`;
    
    res.header('Content-Type', 'application/xml');
    res.send(sitemap);
  });

  const httpServer = createServer(app);
  return httpServer;
}
